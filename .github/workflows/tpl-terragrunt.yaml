name: Terragrunt Workflow Template

on:
  workflow_call:
    inputs:
      action:
        description: "plan | apply"
        required: true
        type: string

concurrency:
  group: terragrunt-${{ github.repository }}-pr-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

env:
  TG_ALL: true
  TG_LOG_LEVEL: error
  TG_NON_INTERACTIVE: true
  # TG_PARALLELISM: 1 // Check if it needed, sometimes with PostgreSQL Backend cause issues with concurrency
  TF_STRICT_MODE: true
  TG_WORKING_DIR: ./iac
  TG_VERSION: v0.99.2
  TOFU_VERSION: v1.11.5
  VAULT_VERSION: v1.20.2
  VAULT_HELPER_VERSION: main
  VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
  VAULT_AGENT_CONFIG: ${{ vars.VAULT_AGENT_CONFIG }}
  VAULT_CLIENT_ID: ${{ secrets.VAULT_CLIENT_ID }}
  VAULT_SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      token: ${{ steps.create_token.outputs.token }}
    steps:
      - name: Validate action input
        run: |
          if [[ "${{ inputs.action }}" != "plan" && "${{ inputs.action }}" != "apply" ]]; then
            echo "Invalid action: ${{ inputs.action }}"
            exit 1
          fi
      - name: Create GitHub App token
        id: create_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ env.GITHUB_APP_ID }}
          private-key: ${{ env.GITHUB_APP_PEM_FILE }}
          owner: ${{ github.repository_owner }}
          github-api-url: ${{ github.api_url }}

  plan:
    needs:
      - setup
    if: ${{ inputs.action == 'plan' }}
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr_context.outputs.pr_number }}
      head_sha: ${{ steps.pr_context.outputs.head_sha }}
      artifact_name: ${{ steps.plan_artifact_meta.outputs.artifact_name }}
    steps:
      - name: Resolve PR context
        id: pr_context
        run: |
          set -euo pipefail
          echo "pr_number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          echo "head_sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
          echo "base_sha=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr_context.outputs.head_sha }}
          fetch-depth: 0

      - name: Install terragrunt
        uses: gruntwork-io/terragrunt-action@v3
        with:
          tg_version: ${{ env.TG_VERSION }}
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Get secrets from vault
        uses: proxmox-home-lab/github-actions/.github/actions/vault-secrets@main
        with:
          vault_version: ${{ env.VAULT_VERSION }}
          vault_helper_version: ${{ env.VAULT_HELPER_VERSION }}

      - name: Detect terragrunt stacks from changed files
        id: detect_stacks
        run: |
          set -euo pipefail

          base_sha="${{ steps.pr_context.outputs.base_sha }}"
          head_sha="${{ steps.pr_context.outputs.head_sha }}"
          tg_dir="${TG_WORKING_DIR#./}"

          mapfile -t changed_files < <(git diff --name-only "$base_sha" "$head_sha" -- "$tg_dir")
          mapfile -t all_stacks < <(find "$tg_dir" -type f -name "terragrunt.stack.hcl" -printf '%h\n' | sort -u)

          if [[ ${#all_stacks[@]} -eq 0 ]]; then
            echo "No terragrunt stacks found under $tg_dir"
            exit 1
          fi

          if [[ ${#changed_files[@]} -eq 0 ]]; then
            echo "No files changed under $tg_dir; using all stacks for safety."
            printf '%s\n' "${all_stacks[@]}" > target_stacks.txt
            echo "target_mode=all_stacks" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          declare -A stacks=()
          global_change=false

          for file in "${changed_files[@]}"; do
            dir="$(dirname "$file")"
            found_stack=""

            while [[ "$dir" != "$tg_dir" && "$dir" != "." && "$dir" != "/" ]]; do
              if [[ -f "$dir/terragrunt.stack.hcl" ]]; then
                found_stack="$dir"
                break
              fi
              dir="$(dirname "$dir")"
            done

            if [[ -n "$found_stack" ]]; then
              stacks["$found_stack"]=1
            else
              # iac/common.hcl, iac/root.hcl, env files, etc. can impact all stacks.
              global_change=true
            fi
          done

          if [[ "$global_change" == "true" ]]; then
            echo "Detected global IaC changes; running all stacks."
            printf '%s\n' "${all_stacks[@]}" > target_stacks.txt
            echo "target_mode=all_stacks" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ ${#stacks[@]} -eq 0 ]]; then
            echo "No stack-specific changes detected; running all stacks for safety."
            printf '%s\n' "${all_stacks[@]}" > target_stacks.txt
            echo "target_mode=all_stacks" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          printf '%s\n' "${!stacks[@]}" | sort > target_stacks.txt

          echo "target_mode=targeted" >> "$GITHUB_OUTPUT"
          echo "Target stacks:"
          cat target_stacks.txt

      - name: Run terragrunt validate
        run: |
          set -euo pipefail

          mapfile -t target_stacks < target_stacks.txt
          for stack_dir in "${target_stacks[@]}"; do
            echo "Validating stack: $stack_dir"
            (
              cd "$stack_dir"
              terragrunt stack run validate
            )
          done

      - name: Run terragrunt plan
        id: terragrunt_plan
        run: |
          set -euo pipefail

          : > plan.log
          exit_code=0
          mapfile -t target_stacks < target_stacks.txt

          for stack_dir in "${target_stacks[@]}"; do
            echo "Planning stack: $stack_dir" | tee -a plan.log
            (
              cd "$stack_dir"
              terragrunt stack run plan -out=tfplan.binary
            ) 2>&1 | tee -a plan.log
            cmd_exit="${PIPESTATUS[0]}"
            if [[ "$cmd_exit" -ne 0 ]]; then
              exit_code="$cmd_exit"
            fi
          done

          exit "$exit_code"

      - name: Build plan artifact metadata
        if: ${{ success() }}
        id: plan_artifact_meta
        run: |
          set -euo pipefail
          artifact_name="terragrunt-plan-pr${{ steps.pr_context.outputs.pr_number }}-sha${{ steps.pr_context.outputs.head_sha }}"
          echo "artifact_name=$artifact_name" >> "$GITHUB_OUTPUT"

      - name: Pack terragrunt plan files
        if: ${{ success() }}
        run: |
          set -euo pipefail
          cd "${TG_WORKING_DIR}"
          find . -type f -name 'tfplan.binary' -print0 | tar --null --files-from=- -czf "$RUNNER_TEMP/terragrunt-plan-files.tgz"

      - name: Prepare target metadata
        if: ${{ success() }}
        run: |
          set -euo pipefail
          echo "${{ steps.detect_stacks.outputs.target_mode }}" > "$RUNNER_TEMP/target_mode.txt"
          cp target_stacks.txt "$RUNNER_TEMP/target_stacks.txt"

      - name: Upload terragrunt plan artifact
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.plan_artifact_meta.outputs.artifact_name }}
          if-no-files-found: error
          retention-days: 14
          path: |
            ${{ runner.temp }}/terragrunt-plan-files.tgz
            ${{ runner.temp }}/target_mode.txt
            ${{ runner.temp }}/target_stacks.txt
            plan.log

      - name: Summarize terragrunt plan
        id: plan_summarize
        uses: proxmox-home-lab/github-actions/.github/actions/tg-summarize@main
        with:
          log_path: plan.log
          mode: plan
          run_outcome: ${{ steps.terragrunt_plan.outcome }}
          github_token: ${{ github.token }}
          repo: ${{ github.repository }}
          run_id: ${{ github.run_id }}
          job_name: ${{ github.job }}

      - name: PR Comment for Plan
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ needs.setup.outputs.token }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            <!-- Terragrunt PR Comment -->
            ${{ steps.plan_summarize.outputs.summary }}

  apply:
    needs:
      - setup
    if: ${{ inputs.action == 'apply' && github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    steps:
      - name: Resolve PR context
        id: pr_context
        env:
          GH_TOKEN: ${{ needs.setup.outputs.token }}
        run: |
          set -euo pipefail
          pr_number="${{ github.event.issue.number }}"
          pr_json="$(gh pr view "$pr_number" --repo "${{ github.repository }}" --json headRefName,headRefOid)"
          head_ref="$(jq -r '.headRefName' <<<"$pr_json")"
          head_sha="$(jq -r '.headRefOid' <<<"$pr_json")"

          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"
          echo "head_ref=$head_ref" >> "$GITHUB_OUTPUT"
          echo "head_sha=$head_sha" >> "$GITHUB_OUTPUT"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr_context.outputs.head_sha }}

      - name: Install terragrunt
        uses: gruntwork-io/terragrunt-action@v3
        with:
          tg_version: ${{ env.TG_VERSION }}
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Install Vault
        uses: eLco/setup-vault@v1
        with:
          vault_version: ${{ env.VAULT_VERSION }}

      - name: Build VAULT HELPER URL
        run: |
          echo "VAULT_HELPER_URL=https://raw.githubusercontent.com/proxmox-home-lab/.github/${VAULT_HELPER_VERSION}/vault-helper.sh" >> "$GITHUB_ENV"

      - name: Load secrets from Vault
        run: |
          source <(curl -s "$VAULT_HELPER_URL")
          env

      - uses: github/command@v2
        id: command
        with:
          command: .apply
          reaction: rocket
          allowed_contexts: "pull_request"
          allowlist: "${{ github.repository_owner }}/apply-approvers"
          allowlist_pat: ${{ needs.setup.outputs.token }}

      - name: Resolve plan run and artifact
        if: ${{ steps.command.outputs.continue }}
        id: resolve_plan_artifact
        env:
          GH_TOKEN: ${{ needs.setup.outputs.token }}
        run: |
          set -euo pipefail
          pr_number="${{ steps.pr_context.outputs.pr_number }}"
          head_sha="${{ steps.pr_context.outputs.head_sha }}"
          workflow_id="$(
            gh api \
              "repos/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
              --jq '.workflow_id'
          )"
          plan_run_id="$(
            gh api \
              "repos/${{ github.repository }}/actions/workflows/${workflow_id}/runs?event=pull_request&status=completed&per_page=100" \
              --jq '.workflow_runs
                | map(select(.conclusion == "success"))
                | map(select(any(.pull_requests[]?; .number == '"$pr_number"')))
                | map(select(.head_sha == "'"$head_sha"'"))
                | sort_by(.created_at)
                | reverse
                | .[0].id'
          )"

          if [[ -z "$plan_run_id" || "$plan_run_id" == "null" ]]; then
            echo "No successful plan run found for PR #$pr_number and head SHA $head_sha"
            exit 1
          fi

          artifact_name="terragrunt-plan-pr${pr_number}-sha${head_sha}"

          echo "plan_run_id=$plan_run_id" >> "$GITHUB_OUTPUT"
          echo "artifact_name=$artifact_name" >> "$GITHUB_OUTPUT"

      - name: Download plan artifact
        if: ${{ steps.command.outputs.continue }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.resolve_plan_artifact.outputs.artifact_name }}
          run-id: ${{ steps.resolve_plan_artifact.outputs.plan_run_id }}
          github-token: ${{ needs.setup.outputs.token }}
          path: ${{ runner.temp }}/terragrunt-plan-artifact

      - name: Extract plan artifact
        if: ${{ steps.command.outputs.continue }}
        run: |
          set -euo pipefail
          tar -xzf "$RUNNER_TEMP/terragrunt-plan-artifact/terragrunt-plan-files.tgz" -C "${TG_WORKING_DIR}"

      - name: Run terragrunt apply
        if: ${{ steps.command.outputs.continue }}
        id: terragrunt_apply
        run: |
          set -euo pipefail

          target_mode="$(cat "$RUNNER_TEMP/terragrunt-plan-artifact/target_mode.txt")"
          if [[ "$target_mode" != "targeted" && "$target_mode" != "all_stacks" ]]; then
            echo "Invalid target_mode: $target_mode"
            exit 1
          fi

          : > apply.log
          exit_code=0
          mapfile -t target_stacks < "$RUNNER_TEMP/terragrunt-plan-artifact/target_stacks.txt"

          for stack_dir in "${target_stacks[@]}"; do
            echo "Applying stack: $stack_dir" | tee -a apply.log
            (
              cd "$stack_dir"
              terragrunt stack run apply tfplan.binary
            ) 2>&1 | tee -a apply.log
            cmd_exit="${PIPESTATUS[0]}"
            if [[ "$cmd_exit" -ne 0 ]]; then
              exit_code="$cmd_exit"
            fi
          done

          exit "$exit_code"

      - name: Summarize terragrunt apply
        if: ${{ always() && steps.command.outputs.continue }}
        id: apply_summarize
        uses: proxmox-home-lab/github-actions/.github/actions/tg-summarize@main
        with:
          log_path: apply.log
          mode: apply
          run_outcome: ${{ steps.terragrunt_apply.outcome }}
          github_token: ${{ needs.setup.outputs.token }}
          repo: ${{ github.repository }}
          run_id: ${{ github.run_id }}
          job_name: ${{ github.job }}

      - name: PR Comment for Apply
        if: ${{ always() && steps.command.outputs.continue }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ steps.pr_context.outputs.pr_number }}
          body: |
            <!-- Terragrunt PR Comment -->
            ${{ steps.apply_summarize.outputs.summary }}

      - name: Merge PR
        if: ${{ steps.terragrunt_apply.outcome == 'success' && steps.pr_context.outputs.head_ref != 'test' }}
        uses: proxmox-home-lab/github-actions/.github/actions/merge-pr@main
        with:
          gh-token: ${{ needs.setup.outputs.token }}
          pr-number: ${{ steps.pr_context.outputs.pr_number }}
          merge-method: merge
          delete-branch: true
          commit-message: "[AUTO] ${{ github.event.issue.title }}"
